name: Reusable PR Reminder Logic

# ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ í˜¸ì¶œë  ìˆ˜ ìˆë„ë¡ ì„¤ì •
on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL: # í˜¸ì¶œí•˜ëŠ” ìª½ì—ì„œ Slack Webhook URLì„ ì „ë‹¬ë°›ìŒ
        required: true
      SLACK_USER_MAP: # (ì„ íƒ) GitHub ìœ ì €ì™€ Slack ìœ ì €ë¥¼ ë§¤í•‘í•˜ê¸° ìœ„í•œ ì •ë³´
        required: false

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: ë¦¬ë·° ìŠ¹ì¸ì´ ë˜ì§€ ì•Šì€ PR ëª©ë¡ ì¡°íšŒ ë° Slack ì•Œë¦¼
        uses: actions/github-script@v7
        with:
          script: |
            // 1) ì˜¤í”ˆëœ PR ëª©ë¡ ì¡°íšŒ
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            const prsToRemind = [];
            // (ì„ íƒ) Slack ë©˜ì…˜ì„ ìœ„í•œ ìœ ì € ë§µí•‘ ì •ë³´ (JSON í˜•íƒœì˜ Secret/Variable)
            const slackUserMap = JSON.parse('${{ secrets.SLACK_USER_MAP || '{}' }}');
            const repoName = context.repo.repo; // í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°

            for (const pr of prs) {
              // ë“œë˜í”„íŠ¸ì´ê±°ë‚˜ 'do-not-remind' ë¼ë²¨ì´ ë¶™ì€ PRì€ ê±´ë„ˆëœ€
              if (pr.draft || pr.labels.some(label => label.name === 'do-not-remind')) {
                continue;
              }
              
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: repoName,
                pull_number: pr.number,
              });

              // 'APPROVED' ìƒíƒœì˜ ë¦¬ë·°ë¥¼ ë‚¨ê¸´ ê³ ìœ í•œ ìœ ì € ëª©ë¡ ìƒì„±
              const approvingReviewers = new Set();
              reviews.forEach(review => {
                if (review.state === 'APPROVED') {
                  approvingReviewers.add(review.user.login);
                }
              });

              const approvalCount = approvingReviewers.size;

              // ìŠ¹ì¸ ìˆ˜ê°€ 3ëª… ë¯¸ë§Œì¸ ê²½ìš°ì—ë§Œ ë¦¬ë§ˆì¸ë” ëª©ë¡ì— ì¶”ê°€
              if (approvalCount < 3) {
                const prInfo = {
                  ...pr,
                  approvalCount: approvalCount,
                  approvers: Array.from(approvingReviewers),
                  reviewers: pr.requested_reviewers.map(r => r.login),
                };
                prsToRemind.push(prInfo);
              }
            }

            // ë¦¬ë§ˆì¸ë“œê°€ í•„ìš”í•œ PRì´ ìˆì„ ê²½ìš° Slack ë©”ì‹œì§€ ì „ì†¡
            if (prsToRemind.length > 0) {
              // --- Slack Block Kitì„ ì‚¬ìš©í•œ ë©”ì‹œì§€ êµ¬ì„± ---
              const blocks = [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ”” ë¦¬ë·° ìŠ¹ì¸ì´ ë” í•„ìš”í•©ë‹ˆë‹¤!"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": `í˜„ì¬ *${prsToRemind.length}ê°œ*ì˜ PRì´ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ];

              for (const pr of prsToRemind) {
                const approverText = pr.approvers.length > 0 ? pr.approvers.join(', ') : 'ì—†ìŒ';
                
                const reviewerMentions = pr.reviewers.map(reviewer => {
                  const slackUserId = slackUserMap[reviewer];
                  return slackUserId ? `<@${slackUserId}>` : reviewer;
                }).join(', ');
                const reviewerText = reviewerMentions.length > 0 ? reviewerMentions : 'ì§€ì •ë˜ì§€ ì•ŠìŒ';

                blocks.push({
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": `*<${pr.html_url}|[${repoName}] #${pr.number} ${pr.title}>*`
                  }
                });
                blocks.push({
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": `*ìŠ¹ì¸ í˜„í™©:*\n${pr.approvalCount}/3` },
                    { "type": "mrkdwn", "text": `*ì‘ì„±ì:*\n${pr.user.login}` },
                    { "type": "mrkdwn", "text": `*ìŠ¹ì¸í•œ ë¦¬ë·°ì–´:*\n${approverText}` },
                    { "type": "mrkdwn", "text": `*ë¦¬ë·° ìš”ì²­:*\n${reviewerText}` }
                  ]
                });
                blocks.push({ "type": "divider" });
              }

              const slackWebhookUrl = "${{ secrets.SLACK_WEBHOOK_URL }}";
              await fetch(slackWebhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ blocks: blocks }), // text ëŒ€ì‹  blocksë¥¼ ì‚¬ìš©
              });
            } else {
              console.log("No PRs needing more approvals found.");
            }
